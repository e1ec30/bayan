import angr
from detectors import BugFoundError
import time

recv = angr.SIM_PROCEDURES["posix"]["recv"]
send = angr.SIM_PROCEDURES["posix"]["send"]
clock_gettime = angr.SIM_PROCEDURES["posix"]["clock_gettime"] 

class gettime_hook(clock_gettime):
    #This hook is to just change the clock_id to CLOCK_REALTIME since they are roughly the same
    def run(self: angr.sim_procedure.SimProcedure, clockid, tp):
        if self.state.solver.is_true(tp == 0):
            return -1
        
        flt = time.time()
        
        result = {
            "tv_sec": int(flt),
            "tv_nsec": int(flt * 1000000000)
        }

        self.state.mem[tp].struct.timespec = result
        return 0

class recv_hook(recv):
    def run(self: angr.sim_procedure.SimProcedure, fd, dst, length, flags):
        max_len = self.state.solver.max(length)
        #print(f"recv: {max_len}")

        self.state.globals["recv_len"] = max_len

        print(self.state.posix.get_fd(fd))

        a = super().run(fd, dst, length, flags)
        return a


class send_hook(send):
    def run(self, fd, dst, length, flags):
        max_len = self.state.solver.max(length)
        #print(f"send: {max_len}")

        self.state.globals["send_len"] = max_len

        if self.state.globals["recv_len"] < self.state.globals["send_len"]: 
            raise BugFoundError(self.state, message="HeartBleed found!")

        a = super().run(fd, dst, length, flags)
        return a
